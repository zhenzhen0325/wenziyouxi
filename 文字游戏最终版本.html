<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ²‰æµ¸å¼æœå†»AIå‰§åœº Ultimate</title>
    <style>
        :root {
            --primary: #ff9a9e;
            --accent: #a18cd1;
            --glass-bg: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.6);
            --text-main: #5c5c5c;
            --bubble-me: #a18cd1;
            --bubble-ai: #ffffff;
            --gradient-bg: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "PingFang SC", "Microsoft YaHei", sans-serif; }

        body {
            background-image: var(--gradient-bg);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            font-size: 14px;
        }

        /* ---------------- APP å®¹å™¨ ---------------- */
        .app-container {
            width: 100%;
            max-width: 480px;
            height: 95vh;
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 2px solid var(--glass-border);
            border-radius: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        /* ---------------- é¡¶éƒ¨æ  ---------------- */
        .header {
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.3);
            border-bottom: 1px solid rgba(255, 255, 255, 0.4);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }
        .header h1 { font-size: 16px; color: #444; font-weight: 700; letter-spacing: 1px; }
        .status-bar { font-size: 10px; color: var(--accent); opacity: 0; transition: opacity 0.3s; }
        
        .icon-btn {
            background: rgba(255,255,255,0.5);
            border: 1px solid #fff;
            border-radius: 50%;
            width: 32px; height: 32px;
            cursor: pointer;
            transition: 0.2s;
            display: flex; justify-content: center; align-items: center;
            font-size: 16px;
        }
        .icon-btn:hover { background: #fff; transform: scale(1.1); }

        /* ---------------- èŠå¤©åŒºåŸŸ ---------------- */
        .chat-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            scroll-behavior: smooth;
        }

        /* æ¶ˆæ¯ä½“ */
        .message-group {
            display: flex;
            gap: 10px;
            max-width: 90%;
            animation: slideIn 0.3s ease-out;
        }
        .message-group.me { align-self: flex-end; flex-direction: row-reverse; }
        
        /* å¤´åƒä¸åå­— */
        .avatar-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 45px;
            flex-shrink: 0;
        }
        .avatar {
            width: 40px; height: 40px;
            border-radius: 50%;
            background-color: #ddd;
            background-size: cover;
            border: 2px solid #fff;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .char-name {
            font-size: 10px;
            color: #666;
            margin-top: 4px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 50px;
            background: rgba(255,255,255,0.5);
            padding: 1px 4px;
            border-radius: 4px;
        }

        /* æ°”æ³¡ */
        .bubble {
            background: #fff;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-main);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            position: relative;
            word-wrap: break-word;
        }
        .message-group.me .bubble {
            background: linear-gradient(120deg, #a18cd1 0%, #fbc2eb 100%);
            color: #fff;
            border-top-right-radius: 4px;
        }
        .message-group:not(.me) .bubble {
            border-top-left-radius: 4px;
        }

        /* æ—ç™½æ ·å¼ */
        .narrator {
            align-self: center;
            background: rgba(255, 255, 255, 0.4);
            border: 1px dashed var(--primary);
            color: #666;
            padding: 8px 15px;
            border-radius: 15px;
            font-size: 12px;
            text-align: center;
            margin: 10px 0;
            max-width: 90%;
        }

        /* ---------------- åº•éƒ¨åŠŸèƒ½åŒº ---------------- */
        .fake-tools {
            display: flex;
            gap: 15px;
            padding: 8px 15px;
            overflow-x: auto;
            background: rgba(255,255,255,0.3);
            border-top: 1px solid rgba(255,255,255,0.4);
        }
        .tool-btn { font-size: 18px; cursor: pointer; opacity: 0.7; transition: 0.2s; min-width: 30px; text-align: center;}
        .tool-btn:hover { opacity: 1; transform: scale(1.1); }

        .input-area {
            background: rgba(255,255,255,0.6);
            padding: 10px;
            border-top: 1px solid rgba(255,255,255,0.5);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-row { display: flex; gap: 8px; justify-content: space-between; }
        
        textarea {
            width: 100%;
            height: 50px;
            border: none;
            border-radius: 12px;
            padding: 10px;
            background: rgba(255,255,255,0.8);
            resize: none;
            outline: none;
            transition: height 0.2s;
        }
        textarea:focus { background: #fff; height: 70px; }

        .btn {
            border: none;
            padding: 0 15px;
            height: 36px;
            border-radius: 10px;
            cursor: pointer;
            color: white;
            font-weight: bold;
            font-size: 12px;
            transition: 0.2s;
            white-space: nowrap;
        }
        .btn-send { background: var(--accent); }
        .btn-ai { background: var(--primary); }
        .btn-auto { background: #667eea; width: 100%; margin-top: 5px; opacity: 0.9; }

        /* è§’è‰²é€‰æ‹©å™¨ */
        .char-selector {
            padding: 5px;
            border-radius: 8px;
            border: 1px solid #ddd;
            background: rgba(255,255,255,0.9);
            font-size: 12px;
            outline: none;
            max-width: 100px;
        }

        /* ---------------- è®¾ç½®é¢æ¿ (Modal) ---------------- */
        .modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            z-index: 100;
            display: none;
            flex-direction: column;
            animation: fadeIn 0.3s;
        }
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        .modal-section { margin-bottom: 25px; }
        .section-title { font-size: 14px; font-weight: bold; color: var(--accent); margin-bottom: 10px; border-left: 3px solid var(--accent); padding-left: 8px; display: flex; justify-content: space-between; align-items: center;}

        .input-group { margin-bottom: 10px; }
        .input-group label { display: block; font-size: 11px; color: #888; margin-bottom: 4px; }
        .input-group input, .input-group textarea, .input-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #f9f9f9;
            font-size: 12px;
        }
        
        .char-list-item {
            background: #fff;
            border: 1px solid #eee;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .btn-small { padding: 4px 8px; font-size: 10px; background: #ddd; color: #333; border-radius: 4px; cursor: pointer; border: none; }
        .btn-save { width: 100%; padding: 12px; font-size: 14px; background: var(--gradient-bg); color: #fff; border:none; border-radius: 12px; margin-top: 10px; box-shadow: 0 5px 15px rgba(161, 140, 209, 0.3); cursor: pointer;}

        /* å¼€å…³æ ·å¼ */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 36px;
            height: 20px;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 20px;
        }
        .slider:before {
            position: absolute; content: "";
            height: 16px; width: 16px;
            left: 2px; bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(16px); }

        /* NPC æ‚¬æµ®èœå• */
        .npc-menu {
            position: absolute; bottom: 80px; right: 10px;
            background: rgba(255,255,255,0.95);
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            display: none; flex-direction: column;
            width: 120px;
            overflow: hidden;
            z-index: 50;
        }
        .npc-option { padding: 10px; font-size: 12px; cursor: pointer; text-align: center; border-bottom: 1px solid #eee; }
        .npc-option:hover { background: #f0f0f0; }

        /* æ¶ˆæ¯æ“ä½œèœå• */
        .msg-menu {
            position: absolute;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 20;
            overflow: hidden;
            min-width: 120px;
        }
        .msg-menu-item {
            padding: 8px 12px;
            font-size: 12px;
            cursor: pointer;
            color: #333;
        }
        .msg-menu-item:hover {
            background: #f5f5f5;
        }

        /* å¤šé€‰æ¨¡å¼æ ·å¼ */
        .msg-checkbox {
            position: absolute;
            top: 5px;
            left: 5px;
            width: 16px;
            height: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            display: none; /* é»˜è®¤éšè— */
        }
        .msg-checkbox.visible {
            display: block;
        }
        .msg-checkbox.checked {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
            text-align: center;
            line-height: 16px;
            font-size: 12px;
            content: "âœ“";
        }

        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header">
        <button class="icon-btn" onclick="openSettings()">âš™ï¸</button>
        <div style="text-align: center;">
            <h1 id="ui-title">ç²‰è‰²å›å¿†</h1>
            <div id="status-bar" class="status-bar">AIæ€è€ƒä¸­...</div>
        </div>
        <button class="icon-btn" onclick="toggleNPC()">ğŸ‘¥</button>
    </div>

    <div class="npc-menu" id="npc-menu">
        <div class="npc-option" onclick="triggerNPC('æ§åœº')">âœ¨ æ§åœºNPC</div>
        <div class="npc-option" onclick="triggerNPC('å¥½äºº')">ğŸ˜‡ å¥½äººNPC</div>
        <div class="npc-option" onclick="triggerNPC('åäºº')">ğŸ˜ˆ åäººNPC</div>
        <div class="npc-option" onclick="triggerNPC('æ™®é€š')">ğŸ˜ æ™®é€šNPC</div>
        <div class="npc-option" onclick="triggerNPC('æƒ…æ•Œ', true)">ğŸ˜¡ æƒ…æ•ŒNPC</div>
    </div>

    <div class="chat-area" id="chat-area">
        <div class="narrator">ç³»ç»Ÿï¼šæ¬¢è¿æ¥åˆ°ä½ çš„ä¸“å±ä¸–ç•Œã€‚è¯·åœ¨è®¾ç½®ä¸­é…ç½®APIå’Œè§’è‰²ã€‚</div>
    </div>

    <div class="fake-tools">
        <div class="tool-btn" onclick="handleTool('transfer')" title="ä¼ªé€ è½¬è´¦">ğŸ’°</div>
        <div class="tool-btn" onclick="handleTool('link')" title="ä¼ªé€ é“¾æ¥">ğŸ”—</div>
        <div style="width:1px; background:rgba(255,255,255,0.5); margin:0 5px;"></div>
        <div class="tool-btn" onclick="handleTool('image')" title="å‘é€å›¾ç‰‡">ğŸ–¼ï¸</div>
        <div class="tool-btn" onclick="handleTool('location')" title="å‘é€å®šä½">ğŸ“</div>
        <div class="tool-btn" onclick="handleTool('file')" title="å‘é€æ–‡ä»¶">ğŸ“</div>
        <div class="tool-btn" onclick="handleTool('music')" title="å‘é€éŸ³ä¹">ğŸµ</div>
    </div>

    <div class="input-area">
        <button class="btn btn-auto" onclick="autoAdvance()">ğŸ¬ è‡ªåŠ¨æ¨è¿›å‰§æƒ… (AIç”Ÿæˆæ—ç™½)</button>
        <textarea id="user-input" placeholder="è¾“å…¥ä½ æƒ³è¯´çš„è¯..."></textarea>
        <div class="control-row">
            <div style="display:flex; align-items:center; gap:5px;">
                <span style="font-size:10px; color:#888;">AIæ‰®æ¼”:</span>
                <select id="char-select" class="char-selector">
                </select>
                <!-- æ–°å¢ï¼šå¤šé€‰æŒ‰é’® -->
                <button class="btn" style="background:#999; font-size:12px; padding:0 10px;" onclick="toggleMultiSelect()">å¤šé€‰</button>
            </div>
            <div style="display:flex; gap:5px;">
                <button class="btn btn-ai" onclick="generateReply()">âœ¨ AIå›å¤</button>
                <button class="btn btn-send" onclick="sendUserMessage()">ğŸš€ å‘é€</button>
            </div>
        </div>
    </div>

    <div class="modal" id="settings-modal">
        <div class="modal-header">
            <h3>âš™ï¸ å‰§åœºè®¾ç½®</h3>
            <button class="icon-btn" onclick="closeSettings()">âœ•</button>
        </div>
        <div class="modal-content">
            
            <div class="modal-section">
                <div class="section-title">ğŸ”Œ API è®¾ç½®</div>
                <div class="input-group">
                    <label>API Key (sk-...)</label>
                    <input type="password" id="api-key">
                </div>
                <div class="input-group">
                    <label>API åœ°å€ (Base URL)</label>
                    <input type="text" id="api-url" value="https://api.openai.com/v1" placeholder="ä¾‹å¦‚ https://api.deepseek.com">
                </div>
                <div class="input-group">
                    <label>é€‰æ‹©æ¨¡å‹</label>
                    <div style="display:flex; gap:5px;">
                        <select id="api-model">
                            <option value="gpt-3.5-turbo">gpt-3.5-turbo (é»˜è®¤)</option>
                            <option value="gpt-4">gpt-4</option>
                        </select>
                        <button class="btn-small" onclick="fetchModels()">ğŸ”„ æ‹‰å–æ¨¡å‹åˆ—è¡¨</button>
                    </div>
                </div>
            </div>

            <div class="modal-section">
                <div class="section-title">
                    ğŸ§  è®°å¿†ç®¡ç†
                    <label class="toggle-switch">
                        <input type="checkbox" id="memory-toggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <p style="font-size:10px; color:#888; margin-bottom:5px;">å¼€å¯åï¼ŒAIä¼šè‡ªåŠ¨æ€»ç»“è¿‡å¾€å‰§æƒ…ã€‚æ€»ç»“å†…å®¹å°†è¢«ä½œä¸ºé•¿æœŸè®°å¿†ï¼Œå‚ä¸AIçš„æ¯ä¸€æ¬¡æ€è€ƒã€‚</p>
            </div>

            <div class="modal-section" style="border: 1px solid #ffe5e5; padding: 10px; border-radius: 8px; background: #fffafb;">
                <div class="section-title" style="color:#d63384; border-color:#d63384;">ğŸ­ æ—ç™½ä¸æå†™è®¾ç½® (AIå¿…é¡»éµå®ˆ)</div>
                <div class="input-group">
                    <label>è¯´è¯å‰çš„æå†™è§„åˆ™ (æ§åˆ¶å¿ƒç†ã€å¤–è²Œã€ç¥æƒ…)</label>
                    <textarea id="narration-prompt" rows="4" placeholder="è®¾ç½®AIè¯´è¯å‰çš„æå†™ä¹ æƒ¯...">è¯·ä¸¥æ ¼éµå®ˆï¼šåœ¨è¿›è¡Œå¯¹è¯å›å¤å‰ï¼Œå¿…é¡»å…ˆç”¨æ‹¬å·()åŒ…è£¹ä¸€æ®µæå†™ã€‚
æå†™å†…å®¹å¿…é¡»åŒ…å«ï¼šä½ å½“å‰å†…å¿ƒçš„çœŸå®å¿ƒç†æ´»åŠ¨ã€ç»†å¾®çš„é¢éƒ¨ç¥æƒ…å˜åŒ–ã€è‚¢ä½“åŠ¨ä½œä»¥åŠå‘¨å›´åœºæ™¯çš„æ°›å›´æ„Ÿã€‚
ä¾‹å¦‚ï¼š(æ‰‹æŒ‡å¾®å¾®é¢¤æŠ–ï¼Œçœ¼ç¥èº²é—ªä¸æ•¢çœ‹ä½ ï¼Œå¿ƒé‡Œå´åœ¨æœŸå¾…ä½ çš„æŒ½ç•™)
æå†™ç»“æŸåæ¢è¡Œï¼Œå†è¯´å‡ºå°è¯ã€‚</textarea>
                </div>
            </div>

            <div class="modal-section">
                <div class="section-title">ğŸŒ ä¸–ç•Œè§‚è®¾å®š</div>
                <div class="input-group">
                    <label>ä¸–ç•ŒèƒŒæ™¯ / æ•…äº‹å¤§çº² (åŒ…å«æƒ…æ•Œè®¾å®š)</label>
                    <textarea id="world-setting" rows="3" placeholder="ä¾‹å¦‚ï¼šè¿™æ˜¯ä¸€ä¸ªé­”æ³•å­¦é™¢ã€‚æ³¨æ„ï¼šæ•…äº‹é‡Œæœ‰ä¸€ä¸ªå«XXçš„æƒ…æ•Œï¼Œç»å¸¸ä¼šå‡ºæ¥æ£ä¹±..."></textarea>
                </div>
                <div class="input-group">
                    <label>è‡ªåŠ¨å‰§æƒ…æ¨è¿›é£æ ¼</label>
                    <input type="text" id="plot-style" placeholder="ä¾‹å¦‚ï¼šæ‚¬ç–‘ã€æµªæ¼«ã€æç¬‘...">
                </div>
            </div>

            <div class="modal-section">
                <div class="section-title">ğŸ‘¤ æˆ‘çš„ä¿¡æ¯</div>
                <div class="input-group">
                    <label>æˆ‘çš„æ˜µç§°</label>
                    <input type="text" id="user-name" value="æˆ‘">
                </div>
                <div class="input-group">
                    <label>æˆ‘çš„å¤´åƒURL</label>
                    <input type="text" id="user-avatar" value="https://api.dicebear.com/7.x/micah/svg?seed=Molly">
                </div>
            </div>

            <div class="modal-section">
                <div class="section-title">ğŸ­ AI è§’è‰²ç®¡ç† (ç‚¹å‡»ä¿å­˜ç”Ÿæ•ˆ)</div>
                <div id="char-list">
                </div>
                <button class="btn-small" onclick="addNewChar()" style="width:100%; margin-top:5px;">+ æ·»åŠ æ–°è§’è‰²</button>
            </div>

            <div class="modal-section">
                <div class="input-group">
                    <label>èŠå¤©æ¡†æ ‡é¢˜</label>
                    <input type="text" id="chat-title-input" value="ç²‰è‰²å›å¿†">
                </div>
                <div class="input-group">
                    <label>èƒŒæ™¯å›¾ç‰‡URL</label>
                    <input type="text" id="bg-img-input" placeholder="http://...">
                </div>
            </div>
            
            <div style="height: 50px;"></div> 
        </div>
        <div style="padding:15px; border-top:1px solid #eee; background:rgba(255,255,255,0.9);">
            <button class="btn-save" onclick="saveSettings()">ğŸ’¾ ä¿å­˜æ‰€æœ‰è®¾ç½®</button>
        </div>
    </div>
</div>

<script>
    // ---------------- æ•°æ®çŠ¶æ€ ----------------
    let config = {
        apiKey: '',
        apiUrl: 'https://api.openai.com/v1',
        model: 'gpt-3.5-turbo',
        worldview: 'ç°ä»£éƒ½å¸‚èƒŒæ™¯ï¼Œæ¸©é¦¨æµªæ¼«çš„æ—¥å¸¸æ•…äº‹ã€‚',
        plotStyle: 'è½»æ¾æ„‰å¿«',
        userName: 'è½¯è½¯',
        userAvatar: 'https://api.dicebear.com/7.x/micah/svg?seed=Molly',
        narrationRule: '', 
        enableMemory: true,
        characters: [
            {
                id: 1,
                name: 'å“¥å“¥',
                avatar: 'https://api.dicebear.com/7.x/micah/svg?seed=Felix',
                prompt: 'ä½ æ˜¯ä¸€ä¸ªæ¸©æŸ”çš„é‚»å®¶å“¥å“¥ï¼Œæ€»æ˜¯å® æººåœ°çœ‹ç€å¦¹å¦¹ã€‚'
            }
        ],
        messages: [] // çŸ­æœŸä¸Šä¸‹æ–‡
    };

    let longTermMemory = ""; // é•¿æœŸè®°å¿†å­˜å‚¨
    // æ–°å¢ï¼šå¤šé€‰ç›¸å…³å…¨å±€å˜é‡
    let multiSelectMode = false;
    let selectedMsgIds = new Set();
    let currentMenu = null; // å½“å‰æ‰“å¼€çš„æ“ä½œèœå•

    // ---------------- UI åˆå§‹åŒ–ä¸æ¸²æŸ“ ----------------
    const chatArea = document.getElementById('chat-area');
    const charSelect = document.getElementById('char-select');
    const npcMenu = document.getElementById('npc-menu');

    function init() {
        // è¯»å–é»˜è®¤å€¼åˆ°UI
        document.getElementById('narration-prompt').value = `è¯·ä¸¥æ ¼éµå®ˆï¼šåœ¨è¿›è¡Œå¯¹è¯å›å¤å‰ï¼Œå¿…é¡»å…ˆç”¨æ‹¬å·()åŒ…è£¹ä¸€æ®µæå†™ã€‚
æå†™å†…å®¹å¿…é¡»åŒ…å«ï¼šä½ å½“å‰å†…å¿ƒçš„çœŸå®å¿ƒç†æ´»åŠ¨ã€ç»†å¾®çš„é¢éƒ¨ç¥æƒ…å˜åŒ–ã€è‚¢ä½“åŠ¨ä½œä»¥åŠå‘¨å›´åœºæ™¯çš„æ°›å›´æ„Ÿã€‚
ä¾‹å¦‚ï¼š(æ‰‹æŒ‡å¾®å¾®é¢¤æŠ–ï¼Œçœ¼ç¥èº²é—ªä¸æ•¢çœ‹ä½ ï¼Œå¿ƒé‡Œå´åœ¨æœŸå¾…ä½ çš„æŒ½ç•™)
æå†™ç»“æŸåæ¢è¡Œï¼Œå†è¯´å‡ºå°è¯ã€‚`;
        
        renderCharSettings();
        updateCharSelect();
    }

    // æ¸²æŸ“è®¾ç½®é¢æ¿é‡Œçš„è§’è‰²åˆ—è¡¨
    function renderCharSettings() {
        const container = document.getElementById('char-list');
        container.innerHTML = '';
        config.characters.forEach((char, index) => {
            const div = document.createElement('div');
            div.className = 'char-list-item';
            div.innerHTML = `
                <div style="flex:1;">
                    <input type="text" placeholder="åå­—" value="${char.name}" onchange="updateChar(${index}, 'name', this.value)" style="margin-bottom:5px; font-weight:bold;">
                    <input type="text" placeholder="å¤´åƒURL" value="${char.avatar}" onchange="updateChar(${index}, 'avatar', this.value)" style="margin-bottom:5px;">
                    <textarea placeholder="äººè®¾/æ€§æ ¼/ç§˜å¯†" onchange="updateChar(${index}, 'prompt', this.value)" rows="2">${char.prompt}</textarea>
                </div>
                <button class="btn-small" style="background:#ff9a9e; color:white;" onclick="removeChar(${index})">åˆ </button>
            `;
            container.appendChild(div);
        });
    }

    function updateCharSelect() {
        charSelect.innerHTML = '';
        config.characters.forEach((char, index) => {
            const opt = document.createElement('option');
            opt.value = index;
            opt.text = char.name;
            charSelect.appendChild(opt);
        });
    }

    // ---------------- æ ¸å¿ƒé€»è¾‘ï¼šèŠå¤©ä¸API ----------------
    function sendUserMessage() {
        const input = document.getElementById('user-input');
        const text = input.value.trim();
        if(!text) return;

        appendMessage(config.userName, config.userAvatar, text, true);
        config.messages.push({role: 'user', content: `${config.userName}: ${text}`});
        input.value = '';
        
        checkMemory(); // æ£€æŸ¥æ˜¯å¦éœ€è¦å‹ç¼©è®°å¿†
    }

    // ------------------- ä¿®æ”¹ï¼šå·¥å…·æ é€»è¾‘ (æ”¯æŒè‡ªå®šä¹‰å†…å®¹) -------------------
    function handleTool(type) {
        let content = "";
        let displayHtml = "";
        
        // 1. éœ€è¦ç©å®¶è¾“å…¥çš„å·¥å…·ï¼ˆè½¬è´¦/é“¾æ¥ï¼‰
        if (type === 'transfer') {
            const amount = prompt("è¯·è¾“å…¥è½¬è´¦é‡‘é¢ (ä¾‹å¦‚ 5200):", "520.00");
            if(amount === null) return;
            const note = prompt("è¯·è¾“å…¥è½¬è´¦å¤‡æ³¨:", "æ‹¿å»èŠ±");
            if(note === null) return;
            displayHtml = `<div style="background:#fa9d3b; color:white; padding:10px; border-radius:8px;">
                            <div style="font-size:12px;">ğŸ’° è½¬è´¦ç»™å¯¹æ–¹</div>
                            <div style="font-size:18px; font-weight:bold;">Â¥${amount}</div>
                            <div style="font-size:12px; opacity:0.8;">å¤‡æ³¨ï¼š${note}</div>
                           </div>`;
            content = `[ç³»ç»Ÿæ¶ˆæ¯ï¼š${config.userName} å‘ä½ è½¬è´¦äº† ${amount} å…ƒï¼Œå¤‡æ³¨ï¼š${note}]`;
        } 
        else if (type === 'link') {
            const title = prompt("è¯·è¾“å…¥é“¾æ¥æ ‡é¢˜:", "ç‚¹å‡»æŸ¥çœ‹");
            if(title === null) return;
            const url = prompt("è¯·è¾“å…¥ç½‘å€URL:", "http://");
            if(url === null) return;
            displayHtml = `<div style="background:#f0f0f0; padding:10px; border-radius:5px; border-left:4px solid #aaa;">
                            <div style="font-weight:bold;">ğŸ”— ${title}</div>
                            <div style="font-size:10px; color:blue;">${url}</div>
                           </div>`;
            content = `[ç³»ç»Ÿæ¶ˆæ¯ï¼š${config.userName} åˆ†äº«äº†ä¸€ä¸ªé“¾æ¥ï¼š${title} (${url})]`;
        }
        // 2. å¯è‡ªå®šä¹‰å†…å®¹çš„å·¥å…·ï¼ˆå›¾ç‰‡/ä½ç½®/æ–‡ä»¶/éŸ³ä¹ï¼‰
        else {
            const toolConfig = {
                'image': { text: 'å‘é€äº†ä¸€å¼ å›¾ç‰‡', icon: 'ğŸ–¼ï¸', color: '#ff9a9e', placeholder: 'å›¾ç‰‡æè¿°ï¼ˆå¦‚ï¼šæµ·è¾¹æ—¥è½ï¼‰' },
                'location': { text: 'å…±äº«äº†ä½ç½®', icon: 'ğŸ“', color: '#a18cd1', placeholder: 'ä½ç½®æè¿°ï¼ˆå¦‚ï¼šXXå’–å•¡é¦†ï¼‰' },
                'file': { text: 'å‘é€äº†ä¸€ä¸ªæ–‡ä»¶', icon: 'ğŸ“', color: '#4facfe', placeholder: 'æ–‡ä»¶åç§°ï¼ˆå¦‚ï¼šæ—…è¡Œè®¡åˆ’.pdfï¼‰' },
                'music': { text: 'åˆ†äº«äº†ä¸€é¦–æ­Œæ›²', icon: 'ğŸµ', color: '#667eea', placeholder: 'æ­Œæ›²åç§°ï¼ˆå¦‚ï¼šæ™´å¤© - å‘¨æ°ä¼¦ï¼‰' }
            };
            const t = toolConfig[type];
            if(t) {
                // è®©ç”¨æˆ·è¾“å…¥è‡ªå®šä¹‰å†…å®¹
                const customText = prompt(`è¯·è¾“å…¥${t.text}çš„æè¿°:`, t.placeholder);
                if(customText === null) return;
                
                displayHtml = `<div style="color:${t.color}; font-weight:bold; font-style:italic;">${t.icon} [${t.text}] ${customText}</div>`;
                content = `[ç³»ç»Ÿæ¶ˆæ¯ï¼š${config.userName} ${t.text}ï¼š${customText}]`;
            }
        }

        if(content) {
            appendMessage(config.userName, config.userAvatar, displayHtml, true);
            config.messages.push({role: 'user', content: content});
        }
    }

    // ------------------- æ ¸å¿ƒï¼šAPI å›å¤ -------------------
    async function generateReply() {
        const charIndex = charSelect.value;
        const char = config.characters[charIndex];
        if(!char) return alert("è¯·å…ˆæ·»åŠ è§’è‰²ï¼");

        showStatus(true);

        // æ„å»º System Prompt (å¼ºåˆ¶äº’åŠ¨)
        const systemPrompt = `
        ä½ æ­£åœ¨è¿›è¡Œä¸€ä¸ªæ–‡å­—è§’è‰²æ‰®æ¼”æ¸¸æˆã€‚
        
        ã€ä¸–ç•Œè§‚ä¸èƒŒæ™¯ã€‘ï¼š${config.worldview}
        (æ³¨æ„ï¼šå¦‚æœä¸–ç•Œè§‚ä¸­æåˆ°äº†å…¶ä»–è§’è‰²æˆ–æƒ…æ•Œï¼Œè¯·åœ¨å¯¹è¯ä¸­è‡ªç„¶åœ°ä½“ç°ä»–ä»¬çš„å­˜åœ¨æˆ–ä¸ä»–ä»¬äº’åŠ¨ã€‚)
        
        ã€é•¿æœŸè®°å¿†æ‘˜è¦ã€‘ï¼š${longTermMemory}
        ã€å½“å‰æ‰®æ¼”è§’è‰²ã€‘ï¼š${char.name}
        ã€è§’è‰²è®¾å®šã€‘ï¼š${char.prompt}
        ã€ä½ çš„åå­—ã€‘ï¼š${char.name}
        
        ã€è¡Œä¸ºå‡†åˆ™ã€‘ï¼š
        1. å¿…é¡»éµå®ˆã€å›å¤è§„åˆ™ã€‘è¿›è¡Œæå†™ã€‚
        2. å¦‚æœç©å®¶å‘é€äº†å·¥å…·æ¶ˆæ¯ï¼ˆå¦‚è½¬è´¦ã€é“¾æ¥ï¼‰ï¼Œè¯·æ ¹æ®è§’è‰²æ€§æ ¼åšå‡ºçœŸå®çš„ååº”ï¼ˆæƒŠè®¶ã€å¼€å¿ƒã€æ‹’ç»ç­‰ï¼‰ã€‚
        3. å¦‚æœå½“å‰åœºæ™¯ä¸­æœ‰NPCå‡ºç°ï¼ˆä¾‹å¦‚æƒ…æ•Œï¼‰ï¼Œä½ å¿…é¡»å¯¹NPCçš„å­˜åœ¨åšå‡ºååº”ï¼Œä¸è¦æ— è§†ä»–ä»¬ã€‚
        
        ã€å›å¤è§„åˆ™ - é‡è¦ã€‘ï¼š
        ${config.narrationRule}
        
        è¯·å®Œå…¨æ²‰æµ¸ï¼Œä¸è¦æš´éœ²ä½ æ˜¯AIã€‚
        `;

        const history = config.messages.slice(-15); // å–æœ€è¿‘15æ¡
        const messages = [
            {role: "system", content: systemPrompt},
            ...history
        ];

        try {
            const reply = await callAPI(messages);
            appendMessage(char.name, char.avatar, reply, false);
            config.messages.push({role: 'assistant', content: reply});
            checkMemory();
        } catch (e) {
            appendNarrator(`ç³»ç»Ÿé”™è¯¯ï¼šæ— æ³•è¿æ¥AI (${e.message})`);
        }
        
        showStatus(false);
    }

    // ------------------- è®°å¿†å‹ç¼©é€»è¾‘ -------------------
    async function checkMemory() {
        if (!config.enableMemory) return;
        
        if (config.messages.length > 20) {
            console.log("æ­£åœ¨å‹ç¼©è®°å¿†...");
            const rest = config.messages.slice(10); // ä¿ç•™åé¢

            // è¿™é‡Œåªæ˜¯æ¨¡æ‹Ÿï¼Œå®é™…åº”ç”¨ä¸­å¯ä»¥è°ƒç”¨APIæ¥æ€»ç»“ toSummarize çš„å†…å®¹
            config.messages = rest; 
            longTermMemory += " ...[éšç€æ—¶é—´çš„æ¨ç§»ï¼Œä¸¤äººçš„å…³ç³»åœ¨äº’åŠ¨ä¸­é€æ¸åŠ æ·±ï¼Œå‘ç”Ÿäº†ä¸€äº›ç”Ÿæ´»çäº‹]..."; 
            
            const div = document.createElement('div');
            div.style.fontSize = "10px"; div.style.color="#ccc"; div.style.textAlign="center";
            div.innerText = "âœ¨ ç³»ç»Ÿå·²å°†æ—§å‰§æƒ…å­˜å…¥é•¿æœŸè®°å¿† âœ¨";
            chatArea.appendChild(div);
        }
    }

    async function autoAdvance() {
        showStatus(true);
        const systemPrompt = `
        ä½ æ˜¯ä¸€ä¸ªæ—ç™½ç³»ç»Ÿã€‚
        ã€ä¸–ç•Œè§‚ã€‘ï¼š${config.worldview}
        ã€é£æ ¼ã€‘ï¼š${config.plotStyle}
        ã€ä»»åŠ¡ã€‘ï¼š
        è¯·æ ¹æ®å½“å‰å¯¹è¯è®°å½•ï¼Œè‡ªåŠ¨æ¨è¿›ä¸€æ®µå‰§æƒ…ã€‚
        ä½ å¯ä»¥å¼•å…¥çªå‘äº‹ä»¶ï¼Œæˆ–è€…æè¿°ç¯å¢ƒå˜åŒ–ã€‚
        å¦‚æœä¸–ç•Œè§‚é‡Œæœ‰â€œæƒ…æ•Œâ€æˆ–â€œç«äº‰å¯¹æ‰‹â€ï¼Œä½ å¯ä»¥å®‰æ’ä»–ä»¬å¶å°”ç™»åœºæˆ–åˆ¶é€ éº»çƒ¦ï¼Œå¢åŠ æˆå‰§æ€§ã€‚
        å­—æ•°300å­—ä»¥å†…ï¼Œä¸è¦ä»¥è§’è‰²èº«ä»½è¯´è¯ï¼Œåªè¾“å‡ºæ—ç™½ã€‚
        `;
        
        const history = config.messages.slice(-10);
        const messages = [{role: "system", content: systemPrompt}, ...history];

        try {
            const text = await callAPI(messages);
            appendNarrator(text);
            config.messages.push({role: 'system', content: `æ—ç™½ï¼š${text}`});
        } catch (e) {
            appendNarrator("æ— æ³•ç”Ÿæˆå‰§æƒ…...");
        }
        showStatus(false);
    }

    // ------------------- NPC è§¦å‘é€»è¾‘ (å«æƒ…æ•Œ) -------------------
    async function triggerNPC(type, isRival = false) {
        toggleNPC();
        showStatus(true);
        
        let specificInstruction = "";
        if (isRival) {
            specificInstruction = "è¿™æ˜¯ä¸€ä¸ªã€æƒ…æ•Œè§’è‰²ã€‘æˆ–ã€åæ´¾è§’è‰²ã€‘ã€‚è¯·è¡¨ç°å‡ºæŒ‘è¡…ã€é˜´é˜³æ€ªæ°”æˆ–è€…ç»¿èŒ¶çš„è¡Œä¸ºï¼Œè¯•å›¾ç ´åç©å®¶å’Œå½“å‰è§’è‰²çš„å…³ç³»ã€‚";
        } else {
            specificInstruction = "è¯·æ ¹æ®ç±»å‹è®¾å®šè¿™ä¸ªè·¯äººNPCçš„è¡Œä¸ºã€‚";
        }

        const systemPrompt = `
        ã€æŒ‡ä»¤ã€‘ï¼šçªç„¶ï¼Œä¸€ä¸ªã€${type}NPCã€‘é—¯å…¥äº†åœºæ™¯ã€‚
        ${specificInstruction}
        è¯·æ ¹æ®ä¸–ç•Œè§‚ "${config.worldview}" ç”Ÿæˆè¿™ä¸ªNPCçš„å„ç§æå†™ã€‚
        
        æ ¼å¼è¦æ±‚ï¼š
        ç¬¬ä¸€è¡Œï¼šNPCçš„åå­— (éšæœºç”Ÿæˆä¸€ä¸ªç¬¦åˆèƒŒæ™¯çš„åå­—)
        ç¬¬äºŒè¡Œï¼šæå†™å†…å®¹ï¼ˆç¥æ€ã€åŠ¨ä½œã€å¯¹ç©å®¶æˆ–ä¸»è§’çš„æ€åº¦ï¼‰
        ç¬¬ä¸‰è¡Œï¼šNPCè¯´çš„å°è¯
        
        NPCå¿…é¡»ä¸å½“å‰å¯¹è¯è¯­å¢ƒç›¸å…³è”ï¼Œä¸è¦è‡ªè¯´è‡ªè¯ã€‚
        `;
        
        const messages = [
            {role: "system", content: systemPrompt},
            ...config.messages.slice(-5)
        ];
        
        try {
            const raw = await callAPI(messages);
            appendMessage("NPC / ç³»ç»Ÿ", "https://api.dicebear.com/7.x/identicon/svg?seed=" + Math.random(), raw, false);
            config.messages.push({role: 'system', content: `NPCäº‹ä»¶ï¼š${raw}`});
        } catch (e) { alert(e); }
        showStatus(false);
    }

    // ---------------- API å·¥å…·å‡½æ•° ----------------
    async function callAPI(messages) {
        if(!config.apiKey) throw new Error("è¯·å…ˆè®¾ç½®API Key");
        
        const response = await fetch(`${config.apiUrl}/chat/completions`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${config.apiKey}`
            },
            body: JSON.stringify({
                model: config.model,
                messages: messages,
                temperature: 0.8
            })
        });

        if(!response.ok) {
            const err = await response.json();
            throw new Error(err.error?.message || "ç½‘ç»œé”™è¯¯");
        }
        const data = await response.json();
        return data.choices[0].message.content;
    }

    async function fetchModels() {
        if(!config.apiKey) return alert("è¯·å…ˆå¡«å†™Key");
        const btn = document.querySelector('#settings-modal .btn-small');
        btn.innerText = "æ‹‰å–ä¸­...";
        
        try {
            const res = await fetch(`${document.getElementById('api-url').value}/models`, {
                headers: { 'Authorization': `Bearer ${document.getElementById('api-key').value}` }
            });
            const data = await res.json();
            
            const select = document.getElementById('api-model');
            select.innerHTML = ''; 
            
            if (data.data && data.data.length > 0) {
                data.data.sort((a,b) => b.id.localeCompare(a.id));
                data.data.forEach(model => {
                    const opt = document.createElement('option');
                    opt.value = model.id;
                    opt.text = model.id;
                    select.appendChild(opt);
                });
                alert(`æˆåŠŸï¼å·²åŠ è½½ ${data.data.length} ä¸ªæ¨¡å‹åˆ°ä¸‹æ‹‰æ¡†ã€‚`);
            } else {
                alert("æœªæ‰¾åˆ°æ¨¡å‹ï¼Œè¯·æ£€æŸ¥æ¥å£ã€‚");
            }
        } catch(e) {
            alert("æ‹‰å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥åœ°å€å’ŒKey");
        }
        btn.innerText = "ğŸ”„ æ‹‰å–æ¨¡å‹åˆ—è¡¨";
    }

    // ---------------- æ¶ˆæ¯æ“ä½œæ ¸å¿ƒå‡½æ•° ----------------
    function appendMessage(name, avatar, content, isMe) {
        const msgId = 'msg_' + Date.now() + Math.random().toString(36).substr(2, 9); // å”¯ä¸€ID
        const div = document.createElement('div');
        div.className = `message-group ${isMe ? 'me' : ''}`;
        div.dataset.id = msgId; // ç»™æ¶ˆæ¯åŠ å”¯ä¸€æ ‡è¯†
        div.dataset.isMe = isMe; // æ ‡è®°æ˜¯å¦æ˜¯è‡ªå·±å‘çš„æ¶ˆæ¯
        
        let finalContent = content;
        if (!content.trim().startsWith('<div')) {
            finalContent = formatContent(content);
        }

        // å¢åŠ ã€Œæ“ä½œèœå•è§¦å‘å™¨ã€+ã€Œå¤šé€‰å¤é€‰æ¡†ã€
        div.innerHTML = `
            <div class="avatar-container">
                <div class="avatar" style="background-image: url('${avatar}');"></div>
                <div class="char-name">${name}</div>
            </div>
            <div class="bubble" style="position:relative;">
                <div class="msg-checkbox" onclick="toggleMsgSelect('${msgId}', event)"></div>
                ${finalContent}
                <div style="position:absolute; right:8px; bottom:4px; opacity:0; transition:opacity 0.2s; font-size:12px; cursor:pointer;" 
                     onclick="showMsgMenu('${msgId}', event)">
                    â€¢â€¢â€¢
                </div>
            </div>
        `;
        chatArea.appendChild(div);
        
        // é¼ æ ‡æ‚¬æµ®æ˜¾ç¤ºã€Œâ€¢â€¢â€¢ã€æŒ‰é’®
        div.querySelector('.bubble').addEventListener('mouseenter', function() {
            this.querySelector('div:last-child').style.opacity = 1;
        });
        div.querySelector('.bubble').addEventListener('mouseleave', function() {
            if (!currentMenu || !currentMenu.contains(this)) {
                this.querySelector('div:last-child').style.opacity = 0;
            }
        });

        scrollToBottom();
        return msgId; // è¿”å›æ¶ˆæ¯IDï¼Œæ–¹ä¾¿åç»­æ“ä½œ
    }

    // æ˜¾ç¤ºæ¶ˆæ¯æ“ä½œèœå•
    function showMsgMenu(msgId, event) {
        event.stopPropagation();
        // å…³é—­å·²æœ‰èœå•
        if (currentMenu) currentMenu.remove();
        
        const msgEl = document.querySelector(`[data-id="${msgId}"]`);
        const isMe = msgEl.dataset.isMe === 'true';
        const bubbleEl = msgEl.querySelector('.bubble');
        const rect = bubbleEl.getBoundingClientRect();

        // åˆ›å»ºèœå•
        const menu = document.createElement('div');
        menu.className = 'msg-menu';
        menu.style.top = `${rect.bottom + window.scrollY}px`;
        menu.style.left = `${rect.right - 120 + window.scrollX}px`;
        currentMenu = menu;

        // èœå•é€‰é¡¹ï¼ˆè‡ªå·±å‘çš„æ¶ˆæ¯æ‰æœ‰ã€Œæ’¤å›ã€ï¼‰
        const menuItems = [
            {text: 'å¤åˆ¶', action: () => copyMsgContent(msgId)},
            {text: 'å¼•ç”¨', action: () => quoteMsg(msgId)},
            ...(isMe ? [{text: 'æ’¤å›', action: () => recallMsg(msgId)}] : []),
            {text: 'å–æ¶ˆ', action: () => closeMsgMenu()}
        ];

        // æ¸²æŸ“èœå•é€‰é¡¹
        menuItems.forEach(item => {
            const itemEl = document.createElement('div');
            itemEl.className = 'msg-menu-item';
            itemEl.innerText = item.text;
            itemEl.onclick = () => {
                item.action();
                menu.remove();
                currentMenu = null;
            };
            menu.appendChild(itemEl);
        });

        document.body.appendChild(menu);
        // ç‚¹å‡»å…¶ä»–åŒºåŸŸå…³é—­èœå•
        document.addEventListener('click', closeMsgMenu, {once: true});
    }

    // å…³é—­æ¶ˆæ¯æ“ä½œèœå•
    function closeMsgMenu() {
        if (currentMenu) {
            currentMenu.remove();
            currentMenu = null;
        }
    }

    // å¤åˆ¶æ¶ˆæ¯å†…å®¹
    function copyMsgContent(msgId) {
        const msgEl = document.querySelector(`[data-id="${msgId}"]`);
        const content = msgEl.querySelector('.bubble').innerText.trim();
        navigator.clipboard.writeText(content).then(() => {
            alert('å†…å®¹å·²å¤åˆ¶ï¼');
        });
    }

    // å¼•ç”¨æ¶ˆæ¯
    function quoteMsg(msgId) {
        const msgEl = document.querySelector(`[data-id="${msgId}"]`);
        const sender = msgEl.querySelector('.char-name').innerText;
        const content = msgEl.querySelector('.bubble').innerText.trim().replace(/\n/g, ' ');
        const input = document.getElementById('user-input');
        input.value = `> ${sender}: ${content}\n${input.value}`;
        input.focus();
    }

    // æ’¤å›æ¶ˆæ¯ï¼ˆä»…è‡ªå·±å‘é€çš„æ¶ˆæ¯ï¼‰
    function recallMsg(msgId) {
        const msgEl = document.querySelector(`[data-id="${msgId}"]`);
        if (confirm('ç¡®å®šæ’¤å›è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ')) {
            // æ›¿æ¢ä¸ºâ€œå·²æ’¤å›â€æç¤º
            msgEl.querySelector('.bubble').innerHTML = '<span style="color:#999; font-style:italic;">[æ¶ˆæ¯å·²æ’¤å›]</span>';
            // ä»config.messagesä¸­ç§»é™¤ï¼ˆç®€åŒ–ç‰ˆï¼‰
            const msgIndex = config.messages.findIndex(item => item.content.includes(msgEl.querySelector('.char-name').innerText));
            if (msgIndex > -1) config.messages.splice(msgIndex, 1);
        }
    }

    // åˆ‡æ¢å¤šé€‰æ¨¡å¼
    function toggleMultiSelect() {
        multiSelectMode = !multiSelectMode;
        const checkboxes = document.querySelectorAll('.msg-checkbox');
        checkboxes.forEach(cb => {
            cb.classList.toggle('visible', multiSelectMode);
        });
        // æ˜¾ç¤º/éšè—â€œåˆ é™¤é€‰ä¸­â€æŒ‰é’®
        let deleteBtn = document.getElementById('delete-selected-btn');
        if (multiSelectMode && !deleteBtn) {
            deleteBtn = document.createElement('button');
            deleteBtn.id = 'delete-selected-btn';
            deleteBtn.className = 'btn';
            deleteBtn.style.background = '#ff5252';
            deleteBtn.innerText = 'åˆ é™¤é€‰ä¸­';
            deleteBtn.onclick = deleteSelectedMsgs;
            document.querySelector('.input-area').appendChild(deleteBtn);
        } else if (!multiSelectMode && deleteBtn) {
            deleteBtn.remove();
            selectedMsgIds.clear();
            // æ¸…ç©ºé€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.msg-checkbox.checked').forEach(cb => {
                cb.classList.remove('checked');
            });
        }
    }

    // åˆ‡æ¢æ¶ˆæ¯é€‰ä¸­çŠ¶æ€
    function toggleMsgSelect(msgId, event) {
        event.stopPropagation();
        const cb = document.querySelector(`[data-id="${msgId}"] .msg-checkbox`);
        if (cb.classList.contains('checked')) {
            cb.classList.remove('checked');
            selectedMsgIds.delete(msgId);
        } else {
            cb.classList.add('checked');
            selectedMsgIds.add(msgId);
        }
    }

    // åˆ é™¤é€‰ä¸­çš„æ¶ˆæ¯
    function deleteSelectedMsgs() {
        if (selectedMsgIds.size === 0) return alert('è¯·é€‰æ‹©è¦åˆ é™¤çš„æ¶ˆæ¯');
        if (confirm(`ç¡®å®šåˆ é™¤${selectedMsgIds.size}æ¡æ¶ˆæ¯å—ï¼Ÿ`)) {
            selectedMsgIds.forEach(msgId => {
                const msgEl = document.querySelector(`[data-id="${msgId}"]`);
                msgEl.remove();
                // ä»config.messagesä¸­ç§»é™¤ï¼ˆç®€åŒ–ç‰ˆï¼‰
                const sender = msgEl.querySelector('.char-name').innerText;
                const msgIndex = config.messages.findIndex(item => item.content.includes(sender));
                if (msgIndex > -1) config.messages.splice(msgIndex, 1);
            });
            selectedMsgIds.clear();
            toggleMultiSelect(); // é€€å‡ºå¤šé€‰æ¨¡å¼
        }
    }

    // ---------------- è¾…åŠ©å‡½æ•° ----------------
    function appendNarrator(text) {
        const div = document.createElement('div');
        div.className = 'narrator';
        div.innerText = text;
        chatArea.appendChild(div);
        scrollToBottom();
    }

    function formatContent(text) {
        return text.replace(/ï¼ˆ(.*?)ï¼‰/g, '<span style="color:#999; font-size:12px; font-style:italic;">ï¼ˆ$1ï¼‰</span>')
                   .replace(/\((.*?)\)/g, '<span style="color:#999; font-size:12px; font-style:italic;">($1)</span>')
                   .replace(/\n/g, '<br>');
    }

    function scrollToBottom() {
        chatArea.scrollTop = chatArea.scrollHeight;
    }

    function showStatus(isLoading) {
        const bar = document.getElementById('status-bar');
        bar.style.opacity = isLoading ? 1 : 0;
    }

    // ---------------- è®¾ç½®ç®¡ç† ----------------
    function openSettings() {
        document.getElementById('settings-modal').style.display = 'flex';
        
        document.getElementById('api-key').value = config.apiKey;
        document.getElementById('api-url').value = config.apiUrl;
        
        const select = document.getElementById('api-model');
        if (![...select.options].some(o => o.value === config.model)) {
            const opt = document.createElement('option');
            opt.value = config.model; opt.text = config.model; opt.selected = true;
            select.appendChild(opt);
        } else {
            select.value = config.model;
        }

        document.getElementById('world-setting').value = config.worldview;
        document.getElementById('plot-style').value = config.plotStyle;
        document.getElementById('user-name').value = config.userName;
        document.getElementById('user-avatar').value = config.userAvatar;
        document.getElementById('chat-title-input').value = document.getElementById('ui-title').innerText;
        
        document.getElementById('narration-prompt').value = config.narrationRule;
        document.getElementById('memory-toggle').checked = config.enableMemory;

        renderCharSettings();
    }

    function closeSettings() {
        document.getElementById('settings-modal').style.display = 'none';
    }

    function saveSettings() {
        config.apiKey = document.getElementById('api-key').value;
        config.apiUrl = document.getElementById('api-url').value;
        config.model = document.getElementById('api-model').value;
        config.worldview = document.getElementById('world-setting').value;
        config.plotStyle = document.getElementById('plot-style').value;
        config.userName = document.getElementById('user-name').value;
        config.userAvatar = document.getElementById('user-avatar').value;
        config.narrationRule = document.getElementById('narration-prompt').value;
        config.enableMemory = document.getElementById('memory-toggle').checked;

        const bg = document.getElementById('bg-img-input').value;
        if(bg) document.body.style.backgroundImage = `url('${bg}'), var(--gradient-bg)`;
        document.body.style.backgroundSize = "cover";

        document.getElementById('ui-title').innerText = document.getElementById('chat-title-input').value;

        updateCharSelect();
        closeSettings();
        alert("è®¾ç½®å·²ä¿å­˜ âœ¨");
    }

    function addNewChar() {
        config.characters.push({name: 'æ–°è§’è‰²', avatar: '', prompt: ''});
        renderCharSettings();
    }
    function removeChar(index) {
        if(confirm("ç¡®å®šåˆ é™¤è¿™ä¸ªè§’è‰²å—ï¼Ÿ")) {
            config.characters.splice(index, 1);
            renderCharSettings();
        }
    }
    window.updateChar = function(index, key, value) {
        config.characters[index][key] = value;
    }

    function toggleNPC() {
        npcMenu.style.display = npcMenu.style.display === 'flex' ? 'none' : 'flex';
    }

    init();
</script>
</body>
</html>